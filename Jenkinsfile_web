pipeline {
    agent any
    stages { 
        stage('build') {
            steps {
                echo "Building"
            }
        }

        stage('deploy_staging') {
            steps {
                echo "Deploying to staging"
            }
            post {
                success {
                    sh 'sh ./send_notification.sh "staging deployment" 0'
                }
                failure {
                    sh 'sh ./send_notification.sh "staging deployment" 1'
                }  
            }
        }
        stage('test_staging') {
            steps {
                echo "Testing on staging"
                sh "docker pull rolandsjlociks/mvn_tests:latest"
                sh "docker compose -f docker-compose-web.yaml up"
                
            }
            parallel {
                    chrome: {
                    sh "docker run -it --network=test-automation-setup rolandsjlociks/mvn_tests mvn clean test -Dbrowser=chrome -DgridURL=chrome:4444"
                    }
                    firefox: {
                    sh "docker run -it --network=test-automation-setup rolandsjlociks/mvn_tests mvn clean test -Dbrowser=firefox -DgridURL=firefox:4444"
                    }
            }
            post {
                success {
                    sh "sh ./send_notification.sh 'staging testing' 0"
                }
                failure {
                    sh "sh ./send_notification.sh 'staging testing' 1"
                }  
            }
        }
        stage('deploy_production') {
            steps {
                echo "Deploying to production"
            }
            post {
                success {
                    sh "sh ./send_notification.sh 'production deployment' 0"
                }
                failure {
                    sh "sh ./send_notification.sh 'production deployment' 1"
                }  
            }
        }
        stage('test_production') {
            steps {
                echo "Testing on production"
                sh "docker pull rolandsjlociks/mvn_tests:latest"
            }
            post {
                success {
                    sh "sh ./send_notification.sh 'production testing' 0"
                }
                failure {
                    sh "sh ./send_notification.sh 'production testing' 1"
                }  
            }
        }
    }
}

    